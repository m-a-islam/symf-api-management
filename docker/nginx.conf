# This is the main server block that will handle all incoming requests.
server {
    # Nginx will listen on port 80 inside the container.
    # The docker-compose.yml file maps your local port (e.g., 8080) to this port.
    listen 80;
    server_name localhost;

    # This is a critical security measure for Symfony.
    # The web root is set to the /public directory, so no sensitive files
    # outside of this directory can ever be accessed from the web.
    root /var/www/html/public;

    # The main entry point for the Symfony application.
    index index.php;

    # This location block handles all requests.
    location / {
        # It tries to serve a file directly ($uri), then a directory ($uri/),
        # and if neither exists, it falls back to the Symfony front controller (index.php).
        # This is how static assets and dynamic API routes are handled correctly.
        try_files $uri $uri/ /index.php?$query_string;
    }

    # This block specifically handles requests for PHP files.
    location ~ \.php$ {
        # This is the most important line:
        # It tells Nginx to pass the request to our PHP-FPM service,
        # which is named 'app' in our docker-compose.yml, on its default port 9000.
        fastcgi_pass app:9000;

        # Standard FastCGI configuration.
        fastcgi_index index.php;
        include fastcgi_params;

        # This tells PHP-FPM which script to execute by providing its full path.
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    # A security measure to deny access to files starting with a dot, like .htaccess.
    location ~ /\.ht {
        deny all;
    }
}